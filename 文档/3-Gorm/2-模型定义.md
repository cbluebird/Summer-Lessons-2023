# 模型定义
在使用ORM工具时，通常我们需要在代码中定义模型（Model）与数据库中的数据表进行映射，在GORM中模型（Model）通常是正常定义的结构体、由 Go 的基本数据类型、实现了 [Scanner](https://pkg.go.dev/database/sql/?tab=doc#Scanner) 和 [Valuer](https://pkg.go.dev/database/sql/driver#Valuer) 接口的自定义类型及其指针或别名组成
例如：
```go
type User struct {
    ID           uint
    Name         string
    Email        *string
    Age          uint8
    Birthday     *time.Time
    MemberNumber sql.NullString
    ActivatedAt  sql.NullTime
    CreatedAt    time.Time
    UpdatedAt    time.Time
}
```

# 自动迁移建表
`AutoMigrate` 会根据结构体帮我们自动创建一个表
```go
DB.AutoMigrate(&User)
```
`AutoMigrate` 的逻辑是只新增，不删除，不修改（可以修改大小）
例如 User 结构体中将 Name 改成 Username，对应的表中会多出一个 username 的字段，但是原本的 name 字段不会删除

# Gorm 约定
GORM 倾向于约定优于配置 默认情况下
- `Gorm` 使用名为 `ID` 的字段作为主键
- 如果没有 `TableName` 函数，使用结构体的蛇形复数作为表名
- 字段名的蛇形作为列名
- 使用 `CreatedAt`、`UpdatedAt` 字段追踪创建更新时间
```go
// 结构体的蛇形复数作为表名（UserInfo --> user_infos）
// 默认列名是字段名的蛇形小写（CreatedAt --> created_at）
type UserInfo struct {
    ID        uint // 默认为主键
    Name      string
    Age       int
    CreatedAt time.Time // 创建记录时，如果该字段值为零值，则将该字段的值设为当前时间
    UpdatedAt time.Time // 更新记录时，将该字段的值设为当前时间，创建记录时，如果该字段值为零值，则将该字段的值设为当前时间
}
```
如果遵循 GORM 的约定，就可以少写一些配置、代码。 当然，如果约定不符合你的实际要求，[GORM 允许你配置它们](https://gorm.io/zh_CN/docs/conventions.html)

## 主键（Primary Key）
GORM 默认会使用名为 ID 的字段作为表的主键，你可以通过标签 `primaryKey` 将其它字段设为主键
```go
// 使用 UUID 作为主键
type User struct {
  ID   uint
  UUID int64 `gorm:"primaryKey"`
  Name string
  Age  int64
}
```

## 复数表名（Table Name）
表名默认就是结构体的蛇形复数，例如：
```go
type User struct {} // 默认表名是 `users`
type UserInfo struct {} // 默认表名是 `user_infos`

// 将 UserInfo 的表名设置为 `user`
func (UserInfo) TableName() string {
  return "user"
}

// 除了这种方式外还有别的方法，比如临时修改表名、修改 Gorm 的命名策略等，这边不多做涉及，可以自行查阅文档
```

## 列名
数据表的列名使用的是 struct 字段名的蛇形命名
可以使用 `column` 标签来覆盖列名
```go
type User struct {
    ID       uint   `gorm:"column:user_id"`  // 将列名设为 `user_id`
    UserName string `gorm:"column:name"`     // 将列名设为 `name`
    Age      int64  `gorm:"column:user_age"` // 将列名设为 `user_age`
}
```

## 时间戳追踪
### CreatedAt
对于有 `CreatedAt` 字段的模型，创建记录时，如果该字段值为零值，则将该字段的值设为当前时间
可以通过将 `autoCreateTime` 标签置为 `false` 来禁用时间戳追踪
```go
type User struct {
    CreatedAt time.Time `gorm:"autoCreateTime:false"`
}
```

### UpdatedAt
对于有 `UpdatedAt` 字段的模型，更新记录时，将该字段的值设为当前时间。创建记录时，如果该字段值为零值，则将该字段的值设为当前时间
可以通过将 `autoUpdateTime` 标签置为 `false` 来禁用时间戳追踪
```go
type User struct {
    UpdatedAt time.Time `gorm:"autoUpdateTime:false"`
}
```

# 结构体标记（tag）
声明 model 时，tag 是可选的，GORM 支持以下 tag：tag 名大小写不敏感，但建议使用 `camelCase` 风格，多个 tag 之间用 `;` 分格

|标签名|说明|
|---|---|
|column|指定 db 列名|
|type|列数据类型，推荐使用兼容性好的通用类型，例如：所有数据库都支持 bool、int、uint、float、string、time、bytes 并且可以和其他标签一起使用，例如：`not null`、`size`, `autoIncrement`… 像 `varbinary(8)` 这样指定数据库数据类型也是支持的。在使用指定数据库数据类型时，它需要是完整的数据库数据类型，如：`MEDIUMINT UNSIGNED not NULL AUTO_INCREMENT`|
|serializer|指定将数据序列化或反序列化到数据库中的序列化器, 例如: `serializer:json/gob/unixtime`|
|size|定义列数据类型的大小或长度，例如 `size: 256`|
|primaryKey|将列定义为主键|
|unique|将列定义为唯一键|
|default|定义列的默认值|
|precision|指定列的精度|
|scale|指定列大小|
|not null|指定列为 NOT NULL|
|autoIncrement|指定列为自动增长|
|autoIncrementIncrement|自动步长，控制连续记录之间的间隔|
|embedded|嵌套字段|
|embeddedPrefix|嵌入字段的列名前缀|
|autoCreateTime|创建时追踪当前时间，对于 `int` 字段，它会追踪时间戳秒数，您可以使用 `nano`/`milli` 来追踪纳秒、毫秒时间戳，例如：`autoCreateTime:nano`|
|autoUpdateTime|创建/更新时追踪当前时间，对于 `int` 字段，它会追踪时间戳秒数，您可以使用 `nano`/`milli` 来追踪纳秒、毫秒时间戳，例如：`autoUpdateTime:milli`|
|index|根据参数创建索引，多个字段使用相同的名称则创建复合索引，查看 [索引](https://gorm.io/zh_CN/docs/indexes.html) 获取详情|
|uniqueIndex|与 `index` 相同，但创建的是唯一索引|
|check|创建检查约束，例如 `check:age > 13`，查看 [约束](https://gorm.io/zh_CN/docs/constraints.html) 获取详情|
|<-|设置字段写入的权限， `<-:create` 只创建、`<-:update` 只更新、`<-:false` 无写入权限、`<-` 创建和更新权限|
|->|设置字段读的权限，`->:false` 无读权限|
|-|忽略该字段，`-` 表示无读写，`-:migration` 表示无迁移权限，`-:all` 表示无读写迁移权限|
|comment|迁移时为字段添加注释|
tag 使用如下：
```go
type User struct {
    ID       uint   `gorm:"autoIncrement"`                    // 自增主键
    Name     string `gorm:"size:10"`                          // 大小为 10 个字符
    Age      int    `gorm:"size:3; check:age > 0"`            // 大小为 3 位数，并且值要 > 0
    Email    string `gorm:"type:varchar(25); unique;"`        // 类型为 varchar(25)，唯一
    Password string `gorm:"type:varchar(20); default:123456"` // 类型为 varchar(20)，默认值为 123456
}
```

# gorm.Model
对于一张数据表的每一条数据来说，都有自增主键，创建、更新与删除时间等比较通用的字段，因此 GORM 将其抽出来并定义了 gorm.Model，包含 `ID`, `CreatedAt`, `UpdatedAt`, `DeletedAt` 四个字段
```go
// gorm.Model 的定义
type Model struct {
    ID        uint `gorm:"primaryKey"`
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt `gorm:"index"`
}
```
你可以将它嵌入到你自己的模型中
```go
type User struct {
    gorm.Model
    Name      string
    Age       int
}

// 等效于  
type User struct {  
  ID        uint           `gorm:"primaryKey"`  
  CreatedAt time.Time  
  UpdatedAt time.Time  
  DeletedAt gorm.DeletedAt `gorm:"index"`  
  Name      string  
  Age       int
}
```
